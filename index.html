<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor Estilo YouTube (Mejorado con Series)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* (Todo tu CSS original, sin cambios) */
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div id="main-loader"></div>
    <div id="load-error-message" class="text-center p-4 hidden text-red-600 dark:text-red-400"></div>
    <div id="app-container" class="flex flex-col h-screen hidden">
        <header class="bg-white dark:bg-gray-800 shadow-md p-3 flex items-center justify-between sticky top-0 z-30 border-b border-gray-200 dark:border-gray-700">
            <!-- (Tu header completo) -->
        </header>
        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="w-60 bg-white dark:bg-gray-800 p-4 overflow-y-auto border-r border-gray-200 dark:border-gray-700">
                <!-- (Tu sidebar completo) -->
            </aside>
            <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 hidden md:hidden"></div>
            <main id="main-content-area" class="flex-1 flex flex-col md:flex-row overflow-y-auto p-4 md:p-6">
                <div class="flex-1 md:pr-6 mb-6">
                    <div id="video-player-container" class="relative bg-black aspect-video rounded-lg overflow-hidden mb-4 shadow-lg group">
                        <video id="video-player" class="w-full h-full" playsinline controlslist="nodownload nofullscreen noremoteplayback"></video>
                        <div id="player-loader" class="absolute inset-0 flex items-center justify-center bg-black/50 hidden">
                            <div class="border-4 border-gray-500 border-t-white rounded-full w-12 h-12 animate-spin"></div>
                        </div>
                        <div id="player-message" class="absolute top-4 left-4 right-4 p-3 rounded text-white text-sm hidden opacity-0"></div>
                        <div id="video-controls" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 p-3 opacity-0 group-hover:opacity-100">
                            <input type="range" id="progress-bar" class="w-full h-1.5 mb-2 appearance-none">
                            <div class="flex items-center justify-between text-white">
                                <button id="play-pause-btn" class="text-xl"><i class="fas fa-play"></i></button>
                                <span id="time-display" class="text-xs font-mono">00:00 / 00:00</span>
                                <button id="speed-btn" class="text-xs px-2 py-1">1x</button>
                                <button id="volume-btn" class="text-xl"><i class="fas fa-volume-up"></i></button>
                                <input type="range" id="volume-slider" class="w-20 h-1.5 appearance-none hidden md:inline-block">
                                <button id="fullscreen-btn" class="text-xl"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                    </div>
                    <h1 id="video-title" class="text-xl md:text-2xl font-bold mb-1">Cargando lista...</h1>
                    <div class="flex items-center mb-4">
                        <div id="channel-logo-container" class="w-10 h-10 rounded-full bg-gray-500 flex items-center justify-center">
                            <i class="fas fa-tv text-white"></i>
                            <img id="channel-logo-img" class="hidden w-full h-full object-contain" />
                        </div>
                        <div class="ml-4">
                            <div id="channel-name" class="font-semibold truncate">Nombre del Canal</div>
                            <div id="subscriber-count" class="text-xs text-gray-500 truncate">Grupo/Subtítulo</div>
                        </div>
                        <button id="favorite-btn" class="ml-auto px-3 py-2 rounded-full bg-gray-100 dark:bg-gray-700"><i class="far fa-star"></i></button>
                    </div>
                    <p id="video-description" class="bg-gray-100 dark:bg-gray-800 p-3 rounded mb-6">Selecciona un canal de la lista de recomendados.</p>
                    <div id="comments-section" class="mb-6">
                        <h2 class="text-lg font-semibold mb-3"><span id="comment-count">0</span> Comentarios</h2>
                        <div class="flex items-start mb-6">
                            <div class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <input type="text" placeholder="Añade un comentario..." class="ml-3 border-b-2 focus:outline-none flex-1 bg-transparent">
                        </div>
                        <div id="comment-list" class="space-y-5"></div>
                    </div>
                </div>
                <aside id="channel-list-sidebar" class="w-full md:w-96">
                    <h2 id="channel-list-title" class="text-lg font-semibold mb-3">Canales Disponibles</h2>
                    <div id="channel-list-container" tabindex="-1" class="space-y-3 max-h-[calc(100vh-250px)] overflow-y-auto">
                        <p id="channel-list-placeholder" class="text-gray-500">Cargando canales...</p>
                    </div>
                </aside>
            </main>
            <div id="settings-view" class="hidden overflow-y-auto p-4 md:p-6 bg-gray-100 dark:bg-gray-900">
                <!-- (Tu vista de configuración) -->
            </div>
        </div>
    </div>

    <script>
        // --- Variables DOM ---
        const mainLoader = document.getElementById('main-loader');
        const appContainer = document.getElementById('app-container');
        const mainContentArea = document.getElementById('main-content-area');
        const settingsView = document.getElementById('settings-view');
        const videoPlayer = document.getElementById('video-player');
        const playerLoader = document.getElementById('player-loader');
        const playerMessage = document.getElementById('player-message');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const progressBar = document.getElementById('progress-bar');
        const timeDisplay = document.getElementById('time-display');
        const speedBtn = document.getElementById('speed-btn');
        const volumeBtn = document.getElementById('volume-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const videoTitle = document.getElementById('video-title');
        const channelLogoContainer = document.getElementById('channel-logo-container');
        const channelLogoImg = document.getElementById('channel-logo-img');
        const channelNameElement = document.getElementById('channel-name');
        const subscriberCountElement = document.getElementById('subscriber-count');
        const videoDescription = document.getElementById('video-description');
        const commentCount = document.getElementById('comment-count');
        const commentList = document.getElementById('comment-list');
        const channelListContainer = document.getElementById('channel-list-container');
        const channelListTitle = document.getElementById('channel-list-title');
        const channelListPlaceholder = document.getElementById('channel-list-placeholder');
        const m3uUrl = 'https://raw.githubusercontent.com/sejo48/chanejorgedez/refs/heads/main/listaoficial.m3u';
        const CACHE_KEY = 'm3u_cache', CACHE_EXPIRATION = 6*60*60*1000;
        let hls, channels = [], currentChannelIndex = -1, playbackRates=[0.5,0.75,1,1.25,1.5,2], currentSpeedIndex=2;
        let favoriteUrls=new Set(), historyUrls=[], currentView='all', currentCategoryGroup=null;
        const THEME_KEY='youtubeClone_theme';

        // --- Parse M3U con temporada/episodio ---
        function parseM3U(text) {
            const lines=text.split('\n'), parsed=[], attrRegex=/tvg-([^=]+)="([^"]*)"/g;
            let ch=null,id=0;
            lines.forEach(l=>{
                const t=l.trim();
                if(t.startsWith('#EXTINF:')){
                    ch={ id:`ch-${id++}`, name:'Desconocido', url:'', logo:null, group:'General', season:1, episode:1 };
                    const info=t.split(/:(.+)/)[1].split(',');
                    ch.name=info[1]||ch.name;
                    let m; while(m=attrRegex.exec(info[0])) {
                        const [k,v]=[m[1],m[2]];
                        if(k==='logo') ch.logo=v;
                        if(k==='group-title') ch.group=v;
                        if(k==='season') ch.season=+v;
                        if(k==='episode') ch.episode=+v;
                    }
                } else if(ch && t && !t.startsWith('#')){
                    ch.url=t; parsed.push(ch); ch=null;
                }
            });
            return parsed;
        }

        // --- Render Series ---
        function renderSeriesView() {
            const series=channels.filter(c=>c.group==='Series de TV');
            const seasons={};
            series.forEach(c=>(seasons[c.season]||(seasons[c.season]=[])).push(c));
            channelListContainer.innerHTML='';
            Object.keys(seasons).sort((a,b)=>a-b).forEach(s=>{
                const h=document.createElement('h3');
                h.className='text-lg font-semibold mb-2';
                h.textContent=`Temporada ${s}`;
                channelListContainer.append(h);
                seasons[s].sort((a,b)=>a.episode-b.episode).forEach(c=>{
                    const d=document.createElement('div');
                    d.className='channel-item p-2 mb-1 rounded-lg hover:bg-gray-200 cursor-pointer';
                    d.textContent=`Ep. ${c.episode} — ${c.name}`;
                    d.onclick=()=>loadVideo(channels.findIndex(x=>x.id===c.id));
                    channelListContainer.append(d);
                });
            });
        }

        // --- Render Genérico ---
        function renderChannelList() {
            channelListContainer.innerHTML='';
            if(currentView==='category'&&currentCategoryGroup==='Series de TV'){
                channelListTitle.textContent='Series de TV';
                channelListPlaceholder.style.display='none';
                return renderSeriesView();
            }
            let list=[], title='';
            if(currentView==='favorites') list=channels.filter(c=>favoriteUrls.has(c.url)), title='Favoritos';
            else if(currentView==='history') list=historyUrls.map(u=>channels.find(c=>c.url===u)).filter(Boolean), title='Historial';
            else if(currentView==='category') list=channels.filter(c=>c.group===currentCategoryGroup), title=`Categoría: ${currentCategoryGroup}`;
            else list=channels, title='Todos los Canales';
            channelListTitle.textContent=title;
            if(!list.length){
                channelListPlaceholder.textContent='No hay canales para mostrar.';
                channelListPlaceholder.style.display='block';
                return;
            }
            channelListPlaceholder.style.display='none';
            list.forEach(c=>{
                const idx=channels.findIndex(x=>x.id===c.id);
                const d=document.createElement('div');
                d.className='channel-item flex items-center p-2 rounded-lg hover:bg-gray-200 cursor-pointer';
                const thumb=document.createElement('div');
                thumb.className='w-24 h-14 bg-gray-200 mr-3 rounded flex items-center justify-center';
                if(c.logo){
                    const img=document.createElement('img');
                    img.src=c.logo; img.className='w-full h-full object-cover';
                    thumb.append(img);
                } else thumb.innerHTML='<i class="fas fa-tv text-2xl text-gray-500"></i>';
                d.append(thumb);
                const info=document.createElement('div');
                info.innerHTML=`<h3 class="font-semibold">${c.name}</h3><p class="text-xs text-gray-500">${c.group}</p>`;
                d.append(info);
                d.onclick=()=>loadVideo(idx);
                channelListContainer.append(d);
            });
        }

        // --- Cargar y reproducir ---
        function loadVideo(i){
            if(i<0||i>=channels.length) return;
            if(hls){hls.stopLoad();hls.detachMedia();}
            videoPlayer.removeAttribute('src'); videoPlayer.load();
            currentChannelIndex=i;
            const c=channels[i];
            document.getElementById('video-title').textContent=c.name;
            document.getElementById('video-description').textContent=`Reproduciendo ${c.name}`;
            channelNameElement.textContent=c.name;
            subscriberCountElement.textContent=c.group;
            channelLogoImg.classList.add('hidden');
            if(c.logo){
                channelLogoImg.src=c.logo; channelLogoImg.classList.remove('hidden');
            }
            playerLoader.classList.remove('hidden');
            if(c.url.endsWith('.m3u8')&&hls){
                hls.loadSource(c.url); hls.attachMedia(videoPlayer); hls.startLoad();
            } else {
                videoPlayer.src=c.url; videoPlayer.load(); videoPlayer.play().catch(()=>{});
            }
        }

        // --- Fetch M3U con caché ---
        async function fetchAndLoadM3U(){
            mainLoader.style.display='block'; appContainer.classList.add('hidden');
            let txt=null;
            const cached=localStorage.getItem(CACHE_KEY);
            if(cached){
                const o=JSON.parse(cached);
                if(Date.now()-o.ts<CACHE_EXPIRATION) txt=o.data;
            }
            if(!txt){
                const res=await fetch(m3uUrl);
                txt=await res.text();
                localStorage.setItem(CACHE_KEY,JSON.stringify({ts:Date.now(),data:txt}));
            }
            channels=parseM3U(txt);
            renderChannelList();
            appContainer.classList.remove('hidden');
            mainLoader.style.display='none';
        }

        document.addEventListener('DOMContentLoaded',()=>{
            hls=new Hls(); hls.attachMedia(videoPlayer);
            fetchAndLoadM3U();
        });
    </script>
</body>
</html>
